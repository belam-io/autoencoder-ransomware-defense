version: '3.8'

networks:
  autoencoder-net:
    driver: bridge

services:

  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: autoencoder-ransomware-defense_zookeeper_1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - autoencoder-net

  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: autoencoder-ransomware-defense_kafka_1
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - autoencoder-net

  producer:
    build: .
    container_name: autoencoder-ransomware-defense_producer_1
    depends_on:
      - kafka
    volumes:
      - .:/app
    # ðŸŒŸ FIX: Explicit command for Kafka readiness and running the script
    command: sh -c "
      /usr/bin/nc -z kafka 9092;
      while [ $$? -ne 0 ]; do
        echo 'Waiting for Kafka to be ready...';
        sleep 1;
        /usr/bin/nc -z kafka 9092;
      done;
      echo 'Connection to kafka ($$(getent hosts kafka | awk '{ print $$1 }')) 9092 port [tcp/*] succeeded!';
      echo 'Kafka is up. Starting producer.';
      python3 kafka_lib/producer.py
      "
    networks:
      - autoencoder-net

  consumer:
    build: .
    container_name: autoencoder-ransomware-defense_consumer_1
    depends_on:
      - kafka
    volumes:
      - .:/app
    # ðŸŒŸ FIX: Explicit command for Kafka readiness and running the script
    command: sh -c "
      /usr/bin/nc -z kafka 9092;
      while [ $$? -ne 0 ]; do
        echo 'Waiting for Kafka to be ready...';
        sleep 1;
        /usr/bin/nc -z kafka 9092;
      done;
      echo 'Connection to kafka ($$(getent hosts kafka | awk '{ print $$1 }')) 9092 port [tcp/*] succeeded!';
      echo 'Kafka is up. Starting consumer.';
      python3 kafka_lib/consumer.py
      "
    networks:
      - autoencoder-net

  siem_dashboard:
    build: .
    container_name: siem_dashboard
    depends_on:
      - consumer # Depend on consumer (optional, but ensures ordering)
    volumes:
      - .:/app
    ports:
      - "8501:8501" # Streamlit UI exposed to host
      # Port 8000 (FastAPI API) is accessible internally via the service name.
    # ðŸŒŸ CRITICAL FIX: Run FastAPI API (port 8000) in the background and then run Streamlit (port 8501)
    command: sh -c "
      pip install fastapi uvicorn pydantic && 
      python3 api.py & 
      streamlit run dashboard.py --server.port 8501 --server.address 0.0.0.0
      "
    networks:
      - autoencoder-net